---
title: "Final Project Visualizations - Draft 1"
author: "Kathryn Denning"
date: "2/25/2019"
output: html_document
---

````{r setup and data import, echo = FALSE, warning = FALSE, message=FALSE, error=FALSE}
library(rio)
library(here)
library(tidyverse)
library(magrittr)
library(RColorBrewer)
library(ggridges)
library(XML)
library(janitor)
library(colorspace)
library(ggridges)
knitr::opts_chunk$set()

#read in data on all UFO citings in Jan 2019
x <- readHTMLTable("http://www.nuforc.org/webreports/ndxe201901.html")
#Turn it into a dataset
ufo_jan19 <- plyr::ldply(x, data.frame)
#power was out, so couldn't google how to add a key when there isn't one - so just wrote it into a csv and added in excel
write.csv(ufo_jan19,'ufo_jan19.csv')
ufo_jan19 <- read_csv("ufo_jan19.csv")

#cleaned dataset to be lowercase and to only include US states
clean <- ufo_jan19 %>%
  clean_names() %>% 
  filter(state_abrv != "AB") %>% 
  filter(state_abrv != "ON") %>% 
  filter(!is.na(state_abrv))

#Read in data of all ufo citings in Oregon ever
y <- readHTMLTable("http://www.nuforc.org/webreports/ndxlOR.html")
#Turn it into a dataset
ufo_oregon <- plyr::ldply(y, data.frame)

#data on the different regions and states
state_region <- read.csv(file="https://raw.githubusercontent.com/cphalpert/census-regions/master/us%20census%20bureau%20regions%20and%20divisions.csv", header=TRUE, sep=",")
```

#Description of data:
These two datafiles come from the National UFO Reporting Center (http://www.nuforc.org/index.html). One dataset includes all of the reported UFO sightings for January 2019. The other file contains all of the reported UFO sightings in Oregon on record. Both datasets include the following variables: date/time, city, state (though for the Oregon dataset this is all one state), shape (of the reported UFO), duration (of the object's appearance), summary (description by the reporter), and date posted (when it was posted on the website). A .id column appeared when converting both datafiles into a dataframe, but is not on the website and all datafilesand will be deleted.

#Description of plots

All plots will be made for a general public audience, though the scientific(?) community interested in UFO sightings might also be interested.

###Plot 1: Choropleth of frequency of reports across US by location
Plot showing the shape of the country with colors changing on the map according to the density of the reports, using changes in color like a heatmap and ideally the viridis color palette. I plan on doing this at the city level within each state, but hopefully can still have the outline of each state visible in the map of the US as well.

```{r plot 1 - chloropleth version 1}
state <- ggplot2::map_data("state")

#need to have a varaible with the full state names in lowercase to merge datasets
state_fullname <- datasets::state.name #calling dataset with state names
state_fullname <- sapply(state.name, tolower) #making them lowercase

state_abbrv <- datasets::state.abb #calling dataset with abbreviations to use as key when merging dataset to get full names in main dataset so that it can be combined with dataset used to make map of US

state_key <- data.frame(
  state_full = state_fullname,
  state_abrv = state_abbrv
) #making dataset with the two character strings state_fullname and state_abbrv

state_key %<>% clean_names

join1 <- left_join(clean, state_key) #joining dataset with fullnames to cleaned ufo dataset

#getting frequency of UFO citings per state
plot1 <- join1 %>% 
  group_by(state_full) %>% 
  count()

#cleaning dataset that has state information for plot of US so that it can be merged
state_fixed <- state %>% 
  mutate(state_full = region) %>% 
  select(-region) %>% 
  clean_names

#merging data with frequency of UFO with plot dataset
plot1_freq_merged <- left_join(state_fixed, plot1)

#code that removes axes from plot of US
ditch_the_axes <- theme(
  axis.text = element_blank(),
  axis.line = element_blank(),
  axis.ticks = element_blank(),
  panel.border = element_blank(),
  panel.grid = element_blank(),
  axis.title = element_blank()
  )

#code that makes US base
state_base <- ggplot(data = plot1_freq_merged, 
                     mapping = aes(x = long, y = lat, group = group)) + 
  coord_fixed(1.3) + 
  geom_polygon(color = "white", fill = "white")

#code that fills the states with frequency data
state_filled <- state_base + 
  geom_polygon(data = plot1_freq_merged, aes(fill = n), color = "white") +
      geom_polygon(color = "white", fill = NA) +
      scale_fill_continuous_sequential("viridis", name = "Frequency") +
  ditch_the_axes

#adding title
state_filled + 
  labs(title = "Frequency of UFO citings per state")
```

####After makung the first chloropleth, I decideed the patterns it is showing might be a little misguided, as the frequency of observations seems to be confounded with the populatin size of the state. I decided to re-do the plot to represent the proportion of observations according to the state population.

```{r plot 1 - chloropleth with proportion of observations per population}
#importing dataset with population stats from the United States Census Bureau
pop <- read_csv("nst-est2018-alldata.csv")

#cleaning the formatting of the names
pop %<>% 
  clean_names() 

#changing the state name variable so that it will be the same when merging later and making data lowercase
pop$state_full <- tolower(pop$name)

#cleaning dataset to exclude areas that weren't in my UFO dataset
pop %<>%
  filter(state_full != "puerto rico") %>% 
  filter(state_full != "district of columbia") %>% 
  filter(state_full != "united states")

#making dataset that is only the 50 states, ignoring the four regions for the moment
pop_state <- pop %>%
  filter(state_full != "northeast region") %>% 
  filter(state_full != "midwest region") %>% 
  filter(state_full != "south region") %>% 
  filter(state_full != "west region")

#merging population dataset with the data on the frequency of UFO observations
pop_state_freq_merged <- left_join(pop_state, plot1_freq_merged)

#converting the frequency of observations to be a proportion
freq_bypop_state <- pop_state_freq_merged %>% 
  group_by(state_full) %>% 
  mutate(freq_bypop = ((n/popestimate2018))) %>% 
  summarize(freq_bypop_perstate = mean(freq_bypop))

#adding the proportion back into the main dataset
pop_state_freq_merged1 <- left_join(plot1_freq_merged, freq_bypop_state)

#base of US for the plot
state_base2 <- ggplot(data = pop_state_freq_merged1 , mapping = aes(x = long, y = lat, group = group)) + 
  coord_fixed(1.3) + 
  geom_polygon(color = "white", fill = "white")

#filling in the states with the proportion data
state_filled2 <- state_base + 
  geom_polygon(data = pop_state_freq_merged1 , aes(fill = freq_bypop_perstate), color = "white") +
      geom_polygon(color = "white", fill = NA) +
      scale_fill_continuous_sequential("viridis", name = "Proprtion") +
  ditch_the_axes

#adding labels
state_filled2 + 
  labs(title = "Proportion of UFO citings per state",
       subtitle = "Proportion determined by number of citings divided by population size")
```

I then decided that another way to visualized this information might be to make a barplot showing the frequency of observations by state and region with state organized in descending order in regards to population, to show outlier states with more observations that other states around their same size in population.

```{r}
#made the population dataset to include a variable of region
pop_region <- pop %>%
  select(c(state_full, popestimate2018, region)) %>%  
  filter(state_full != "northeast region") %>% 
  filter(state_full != "midwest region") %>% 
  filter(state_full != "south region") %>% 
  filter(state_full != "west region") %>% 
  mutate(region = factor(region, labels = c("Northeast",
                                              "Midwest",
                                              "South",
                                              "West"))) 


#merged population region dataset with overall dataset with dataset with state names and regions to create key that can merge with the UFO obersevation dataset
region_withfullstate <- left_join(state_key, pop_region)

#merged region data with UFO observation data
pop_freq_state_region <- left_join(region_withfullstate, clean)

#Make a frequency of observations from this dataset
freq_bystate <- pop_freq_state_region %>% 
  group_by(state_abrv) %>% 
  count()

#merged the frequency variable back into the overall dataset
plot_freq_bystate_andregion <- left_join(pop_freq_state_region, freq_bystate)

#got rid of variables I didn't want and repeat rows 
plot_freq_bystate_andregion2 <- plot_freq_bystate_andregion %>% 
  select(state_abrv, popestimate2018, region, n) %>% 
  unique()

#bar plot
ggplot(plot_freq_bystate_andregion2, aes(reorder(state_abrv, popestimate2018), n)) +
  geom_col(aes(fill = region)) +
  ylim(0,25) +
  coord_flip() +
  theme_minimal() +
  scale_fill_viridis_d(name = "Region") +
  labs(title = "Frequency of UFO observations by state and region",
       subtitle = "States in descending order by population size",
       y = "Frequency of UFO observations",
       x = "State")
```


###Plot 2: A heatmap showing the frequency of reports over days in the last month
Heatmap will show frequency of reports on the y-axis and time on the x-axis. I plan on using the viridis color palette.

```{r}
#cleaning date_time variable to be separate variables and making date interpretable using lubridate
plot2_time <- join1 %>% 
  separate(date_time, c("date", "time"), sep = " ") %>% 
  mutate(date = lubridate::mdy(date),
         state = state_abrv) 

#then getting frequncy of observations per state per day
plot2_state <- plot2_time %>% 
  group_by(state, date) %>% 
  count()

#doing the same but for region instead of state
##first need to merge datasets to have region information
join2 <- left_join(region_withfullstate, plot2_region)

##now getting frequency
plot2_region_joined <-join2 %>% 
  group_by(region, date) %>% 
  count()

#heatmap of observations per state per day
ggplot(plot2 , aes(state, date)) +
    geom_tile(aes(fill = n)) +
scale_fill_viridis_c() +
  coord_flip()

#heatmap of observations per region per day
ggplot(plot2_region_joined, aes(region, date)) +
  geom_tile(aes(fill = n)) +
  scale_fill_viridis_c(name = "Frequency") +
  theme_minimal()
```

Started with this heatmap, did it by state and by region, and realized that, without observations each day, a heatmap really wasn't going to work too well and there wasn't enough data overtime (only a month) to really bin lerger time intervals. If you have suggestions of how to improve this, please let me know.


###Plot 3: A scatterplot showing reports over days in the last month by shape
Scatterplot showing the frequency of reports on the y-axis across time in days on x-axis grouped by shape. I plan on displaying shape by (ideally) using corresponding shapes as the dots, though otherwise I might identify shape by color or with lines/geom_ribbon corresponding with shape. 

```{r}


```
###Plot 4: Choropleth of frequency of reports across Oregon by location
Plot showing the shape of the state of Oregon with colors changing on the map according to the density of the reports, using changes in color like a heatmap and ideally the viridis color palette. I would like to have either county outlines on the state and cities also identified on the map for reference (like Eugene, Portland, Bend, McMinville (UFO festival location, has to be identified!)).

###Plot 5: A plot showing frequency of reports by city in Oregon (top 10)
Barplot with frequency on the y-axis and city on the x-axis, most likely with the axes switched. I haven't thought of what color scheme I might want to designate city.




